<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORMATION - STRATEGY BATTLE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #1a1a1d; --panel: #2c2c2e; --accent: #00fbff; --red: #ff4757; --blue: #2ed573; --valid: rgba(255, 255, 255, 0.2); }
        body { background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; touch-action: manipulation; }
        .screen { display: none; width: 100%; max-width: 500px; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        .card { background: var(--panel); padding: 25px; border-radius: 20px; width: 100%; border: 1px solid #444; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-sub { background: #444; color: #ccc; }
        
        /* ë³´ë“œ ìŠ¤íƒ€ì¼ */
        .board { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: #333; padding: 10px; border-radius: 12px; width: 100%; aspect-ratio: 1; box-sizing: border-box; }
        .cell { background: #1a1a1d; border-radius: 4px; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .stone { width: 80%; height: 80%; border-radius: 50%; box-shadow: inset 0 -3px 5px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .stone.red { background: var(--red); }
        .stone.blue { background: var(--blue); }
        .last-move::after { content: ''; position: absolute; width: 30%; height: 30%; background: #fff; border-radius: 50%; opacity: 0.8; }
        .valid-move { background: var(--valid); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.5; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>

    <div id="authScreen" class="screen active">
        <div class="card">
            <h1 style="color:var(--accent);">FORMATION</h1>
            <p style="color:#888; font-size:0.9rem;">4ëª© ì „ëµ ê²Œì„</p>
            <input type="text" id="nickInput" style="width:100%; padding:15px; margin-bottom:10px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ë‹‰ë„¤ì„">
            <input type="email" id="email" style="width:100%; padding:15px; margin-bottom:10px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" style="width:100%; padding:15px; margin-bottom:20px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn" onclick="handleAuth('login')">ë¡œê·¸ì¸</button>
            <button class="btn" onclick="handleAuth('signup')" style="background:#333; color:white;">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--accent)">LOBBY</h2>
            <p><span id="displayNick" style="font-weight:bold;"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</p>
            <p>ë‚´ ìŠ¹ì : <span id="myScore" style="color:var(--accent); font-weight:bold;">0</span> Point</p>
            
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            <p style="color:#888; font-size:0.8rem;">ğŸ¤– AI ëŒ€ì „ (ì—°ìŠµ)</p>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-sub" onclick="startAI(1)">ì´ˆê¸‰</button>
                <button class="btn btn-sub" onclick="startAI(2)">ì¤‘ê¸‰</button>
                <button class="btn btn-sub" onclick="startAI(3)" style="color:var(--red);">ê³ ê¸‰</button>
            </div>
            
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            <p style="color:#888; font-size:0.8rem;">âš”ï¸ ì‹¤ì‹œê°„ ìœ ì € ëŒ€ì „</p>
            <button class="btn" onclick="findMatch()">ì˜¨ë¼ì¸ ë§¤ì¹­ ì‹œì‘</button>
            <button class="btn btn-sub" onclick="auth.signOut()" style="margin-top:20px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="waitScreen" class="screen">
        <div class="card">
            <h2>MATCHING...</h2>
            <p>ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-sub" onclick="cancelMatch()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="p1Name" style="color:var(--red); font-weight:bold;">RED (ë‚˜)</span>
                <span id="turnInfo" style="background:#fff; color:#000; padding:2px 10px; border-radius:10px; font-size:0.8rem;">ë‚´ ì°¨ë¡€</span>
                <span id="p2Name" style="color:var(--blue); font-weight:bold;">BLUE (AI)</span>
            </div>
            <div id="board" class="board"></div>
            <p id="gameMsg" style="color:var(--accent); font-size:0.9rem; height:20px; margin-top:10px;"></p>
            <button id="quitBtn" class="btn btn-sub" onclick="quitGame()">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // [ê°ë…ë‹˜ ì œê³µ Firebase Config ìœ ì§€]
        const firebaseConfig = {
            apiKey: "AIzaSyBZZuQHXYsbbJA3L1L8-yFSfbw1w15p3NE",
            authDomain: "rubigs.firebaseapp.com",
            databaseURL: "https://rubigs-default-rtdb.firebaseio.com",
            projectId: "rubigs",
            appId: "1:175818594996:web:2ec5f57abe5f5a20d3d5e1",
            measurementId: "G-DMYD96BWBN"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let myUid = "", myNick = "", myScore = 0;
        let isOnline = false, battleId = null, playerColor = 1; // 1:Red, 2:Blue
        let turn = 1, board = [], lastMove = null; // lastMove: {r, c}
        let aiLevel = 0, isGameOver = false;

        // [ì¸ì¦ ë° ì ìˆ˜ ë¡œë“œ] - ë£¨ë¹…ìŠ¤ ë ˆì´ìŠ¤ì™€ ì ìˆ˜ ì €ì¥ì†Œ ë¶„ë¦¬ (formation_score)
        auth.onAuthStateChanged(user => {
            if(user) {
                myUid = user.uid;
                db.ref(`users/${myUid}`).on('value', snap => {
                    const val = snap.val();
                    myNick = val ? val.nickname : "Player";
                    myScore = val && val.formation_score ? val.formation_score : 0; // [ë¶„ë¦¬ëœ ì ìˆ˜]
                    document.getElementById('displayNick').innerText = myNick;
                    document.getElementById('myScore').innerText = myScore;
                    showScreen('lobbyScreen');
                });
            } else { showScreen('authScreen'); }
        });

        function handleAuth(mode) {
            const e = document.getElementById('email').value, p = document.getElementById('password').value, n = document.getElementById('nickInput').value;
            if(mode==='signup') { auth.createUserWithEmailAndPassword(e,p).then(res=>db.ref(`users/${res.user.uid}`).set({nickname:n, formation_score:0})); }
            else { auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message)); }
        }

        // [ê²Œì„ ë¡œì§ í•µì‹¬]
        function initGame(online, level=0, startTurn=1) {
            isOnline = online; aiLevel = level; turn = 1; isGameOver = false; lastMove = null;
            playerColor = (online && startTurn === 2) ? 2 : 1; // ì˜¨ë¼ì¸ì¼ ë•Œ í›„ê³µì´ë©´ Blue
            
            // ë³´ë“œ ì´ˆê¸°í™” (0:ë¹ˆì¹¸, 1:Red, 2:Blue)
            board = Array(7).fill().map(() => Array(7).fill(0));
            renderBoard();
            updateUI();
            
            if(!online && playerColor === 2) setTimeout(aiTurn, 500); // AIê°€ ì„ ê³µì¸ ê²½ìš°
        }

        function renderBoard() {
            const b = document.getElementById('board'); b.innerHTML = '';
            const validMoves = getValidMoves();
            
            for(let r=0; r<7; r++) {
                for(let c=0; c<7; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    // ëŒ ê·¸ë¦¬ê¸°
                    if(board[r][c] !== 0) {
                        const stone = document.createElement('div');
                        stone.className = `stone ${board[r][c] === 1 ? 'red' : 'blue'}`;
                        cell.appendChild(stone);
                        if(lastMove && lastMove.r === r && lastMove.c === c) stone.classList.add('last-move');
                    } 
                    // íŒíŠ¸ ê·¸ë¦¬ê¸° (ë‚´ í„´ì¼ ë•Œë§Œ)
                    else if(!isGameOver && ((isOnline && turn === playerColor) || (!isOnline && turn === 1))) {
                        // validMovesì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í‘œì‹œ
                        if(validMoves.some(m => m.r === r && m.c === c)) {
                            cell.classList.add('valid-move');
                            cell.onclick = () => makeMove(r, c);
                        }
                    }
                    b.appendChild(cell);
                }
            }
        }

        function getValidMoves() {
            let moves = [];
            // ì²« ìˆ˜ëŠ” ì•„ë¬´ë°ë‚˜ (ë³´í†µ ì¤‘ì•™)
            if(lastMove === null) {
                for(let r=0; r<7; r++) for(let c=0; c<7; c++) if(board[r][c]===0) moves.push({r,c});
                return moves;
            }
            
            // 8ë°©í–¥ ì²´í¬
            for(let dr=-1; dr<=1; dr++) {
                for(let dc=-1; dc<=1; dc++) {
                    if(dr===0 && dc===0) continue;
                    let nr = lastMove.r + dr, nc = lastMove.c + dc;
                    if(nr>=0 && nr<7 && nc>=0 && nc<7 && board[nr][nc]===0) moves.push({r:nr, c:nc});
                }
            }
            
            // [í”„ë¦¬ ë£°] ë‘˜ ê³³ì´ ì—†ìœ¼ë©´ ì „ì²´ ì˜¤í”ˆ
            if(moves.length === 0) {
                for(let r=0; r<7; r++) for(let c=0; c<7; c++) if(board[r][c]===0) moves.push({r,c});
            }
            return moves;
        }

        function makeMove(r, c) {
            if(isGameOver) return;
            
            // ìˆ˜ ë‘ê¸°
            board[r][c] = turn;
            lastMove = {r, c};
            
            // ìŠ¹ë¦¬ ì²´í¬
            if(checkWin(r, c, turn)) {
                endGame(turn);
                if(isOnline) db.ref(`formation_battles/${battleId}`).update({board, lastMove, turn, winner: turn});
                return;
            }

            // í„´ ë„˜ê¸°ê¸°
            turn = turn === 1 ? 2 : 1;
            renderBoard();
            updateUI();

            // ì˜¨ë¼ì¸ ë™ê¸°í™”
            if(isOnline) {
                db.ref(`formation_battles/${battleId}`).update({board, lastMove, turn});
            } else {
                // AI í„´ í˜¸ì¶œ
                if(turn === 2) setTimeout(aiTurn, 500);
            }
        }

        function checkWin(r, c, p) {
            const directions = [[0,1], [1,0], [1,1], [1,-1]]; // ê°€ë¡œ, ì„¸ë¡œ, ëŒ€ê°ì„ 
            for(let d of directions) {
                let count = 1;
                for(let k=1; k<4; k++) { // ì •ë°©í–¥
                    let nr=r+d[0]*k, nc=c+d[1]*k;
                    if(nr<0||nr>6||nc<0||nc>6||board[nr][nc]!==p) break;
                    count++;
                }
                for(let k=1; k<4; k++) { // ì—­ë°©í–¥
                    let nr=r-d[0]*k, nc=c-d[1]*k;
                    if(nr<0||nr>6||nc<0||nc>6||board[nr][nc]!==p) break;
                    count++;
                }
                if(count >= 4) return true;
            }
            return false;
        }

        // [AI ë¡œì§] - ì´ˆ/ì¤‘/ê³ ê¸‰
        function aiTurn() {
            if(isGameOver) return;
            const validMoves = getValidMoves();
            if(validMoves.length === 0) return; // ë¬´ìŠ¹ë¶€ ì²˜ë¦¬ í•„ìš”í•˜ë‚˜ ìƒëµ

            let pick = validMoves[0];

            if(aiLevel === 1) { 
                // [ì´ˆê¸‰] ì™„ì „ ëœë¤
                pick = validMoves[Math.floor(Math.random() * validMoves.length)];
            } else {
                // [ì¤‘/ê³ ê¸‰] ìŠ¹ë¦¬ìˆ˜/ë°©ì–´ìˆ˜ ì°¾ê¸°
                // 1. ë‚´ê°€ ë‹¹ì¥ ì´ê¸°ëŠ” ìˆ˜ ìˆìœ¼ë©´ ë‘ 
                let winMove = validMoves.find(m => {
                    board[m.r][m.c] = 2; // AIê°€ ë‘¬ë´„
                    let win = checkWin(m.r, m.c, 2);
                    board[m.r][m.c] = 0; // ì›ìƒë³µêµ¬
                    return win;
                });

                if(winMove) pick = winMove;
                else {
                    // 2. ìƒëŒ€ê°€ ë‹¤ìŒ í„´ì— ì´ê¸°ëŠ”ê±° ë§‰ê¸° (ë°©ì–´)
                    let blockMove = validMoves.find(m => {
                        board[m.r][m.c] = 1; // í”Œë ˆì´ì–´ê°€ ë’€ë‹¤ê³  ê°€ì •
                        let win = checkWin(m.r, m.c, 1);
                        board[m.r][m.c] = 0;
                        return win;
                    });
                    
                    if(blockMove) pick = blockMove;
                    else if(aiLevel === 3) {
                         // [ê³ ê¸‰] ì¤‘ì•™ ì§€í–¥ì  + ëœë¤
                         validMoves.sort((a,b) => Math.abs(3-a.r)+Math.abs(3-a.c) - (Math.abs(3-b.r)+Math.abs(3-b.c)));
                         pick = validMoves[0]; // ì¤‘ì•™ì— ê°€ê¹Œìš´ ìˆ˜
                    } else {
                        // [ì¤‘ê¸‰] ê·¸ëƒ¥ ëœë¤
                        pick = validMoves[Math.floor(Math.random() * validMoves.length)];
                    }
                }
            }
            makeMove(pick.r, pick.c);
        }

        // [ì˜¨ë¼ì¸ ë§¤ì¹­ ë¡œì§] - formation ì „ìš© í ì‚¬ìš©
        function findMatch() {
            showScreen('waitScreen');
            const queueRef = db.ref('formation_queue');
            
            queueRef.once('value', snap => {
                const val = snap.val();
                if(!val) {
                    queueRef.set(myUid);
                    queueRef.onDisconnect().remove();
                    
                    // ëŒ€ê¸° ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
                    const myBattle = db.ref('formation_battles').orderByChild('p1').equalTo(myUid).limitToLast(1);
                    myBattle.on('child_added', s => {
                        if(Date.now() - s.val().timestamp < 10000) { // ìµœê·¼ ìƒì„±ëœ ë°©
                            startOnlineGame(s.key, 1, s.val().p2Name);
                        }
                    });
                } else if (val !== myUid) {
                    const p1 = val;
                    queueRef.set(null); // í ë¹„ì›€
                    const newRef = db.ref('formation_battles').push();
                    battleId = newRef.key;
                    
                    // P1 ë‹‰ë„¤ì„ ê°€ì ¸ì™€ì„œ ì €ì¥í•˜ë©´ ì¢‹ì§€ë§Œ ìƒëµ, P2ì¸ ë‚´ê°€ ë°© ë§Œë“¦
                    newRef.set({
                        p1: p1, p2: myUid, p2Name: myNick,
                        board: Array(7).fill().map(()=>Array(7).fill(0)),
                        turn: 1, lastMove: null, winner: null, timestamp: Date.now()
                    }).then(() => startOnlineGame(battleId, 2, "ìƒëŒ€ë°©")); // P2(Blue)ë¡œ ì‹œì‘
                }
            });
        }

        function startOnlineGame(bid, pColor, oppName) {
            battleId = bid;
            playerColor = pColor;
            showScreen('gameScreen');
            document.getElementById('p1Name').innerText = pColor===1 ? `RED (${myNick})` : `RED (${oppName})`;
            document.getElementById('p2Name').innerText = pColor===2 ? `BLUE (${myNick})` : `BLUE (${oppName})`;
            initGame(true, 0, 1); // ì˜¨ë¼ì¸, AIë ˆë²¨0, 1í„´ë¶€í„°

            // ê²Œì„ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
            db.ref(`formation_battles/${battleId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                
                board = data.board;
                lastMove = data.lastMove;
                turn = data.turn;
                
                if(data.winner) {
                    endGame(data.winner);
                } else {
                    renderBoard();
                    updateUI();
                }
            });
        }

        function endGame(winner) {
            isGameOver = true;
            let msg = "";
            if(isOnline) {
                if(winner === playerColor) { msg = "ğŸ‰ ìŠ¹ë¦¬! (+10ì )"; updateScore(10); }
                else { msg = "íŒ¨ë°°... (-5ì )"; updateScore(-5); }
            } else {
                if(winner === 1) msg = "ğŸ‰ AIë¥¼ ì´ê²¼ìŠµë‹ˆë‹¤!";
                else msg = "AIì—ê²Œ ì¡ŒìŠµë‹ˆë‹¤...";
            }
            document.getElementById('gameMsg').innerText = msg;
            renderBoard(); // ë§ˆì§€ë§‰ ìˆ˜ ë³´ì—¬ì£¼ê¸° ìœ„í•´
        }

        function updateUI() {
            const isMyTurn = (isOnline && turn === playerColor) || (!isOnline && turn === 1);
            const tText = document.getElementById('turnInfo');
            tText.innerText = isMyTurn ? "ë‚´ ì°¨ë¡€" : "ìƒëŒ€ë°© ì°¨ë¡€";
            tText.style.background = turn === 1 ? "var(--red)" : "var(--blue)";
            tText.style.color = "#fff";
        }

        function updateScore(v) {
            db.ref(`users/${myUid}/formation_score`).transaction(c => (c||0) + v);
        }

        function cancelMatch() {
            db.ref('formation_queue').transaction(c => c===myUid ? null : c);
            showScreen('lobbyScreen');
        }

        function startAI(lv) {
            showScreen('gameScreen');
            document.getElementById('p1Name').innerText = "RED (ë‚˜)";
            document.getElementById('p2Name').innerText = "BLUE (AI)";
            initGame(false, lv, 1);
        }
        
        function quitGame() {
            if(isOnline && !isGameOver) updateScore(-5); // íƒˆì£¼ íŒ¨ë„í‹°
            if(battleId) db.ref(`formation_battles/${battleId}`).off();
            showScreen('lobbyScreen');
        }
        
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    </script>
</body>
</html>
