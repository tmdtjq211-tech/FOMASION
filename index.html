<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORMATION - STRATEGY BATTLE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #1a1a1d; --panel: #2c2c2e; --accent: #00fbff; --red: #ff4757; --blue: #2ed573; --valid: rgba(255, 255, 255, 0.2); }
        body { background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; touch-action: manipulation; }
        .screen { display: none; width: 100%; max-width: 500px; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        .card { background: var(--panel); padding: 25px; border-radius: 20px; width: 100%; border: 1px solid #444; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-sub { background: #444; color: #ccc; }
        .board { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: #333; padding: 10px; border-radius: 12px; width: 100%; aspect-ratio: 1; box-sizing: border-box; }
        .cell { background: #1a1a1d; border-radius: 4px; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .stone { width: 80%; height: 80%; border-radius: 50%; box-shadow: inset 0 -3px 5px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .stone.red { background: var(--red); }
        .stone.blue { background: var(--blue); }
        .last-move::after { content: ''; position: absolute; width: 30%; height: 30%; background: #fff; border-radius: 50%; opacity: 0.8; }
        .valid-move { background: var(--valid); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 0.5; } 100% { opacity: 0.2; } }
    </style>
</head>
<body>

    <div id="authScreen" class="screen active">
        <div class="card">
            <h1 style="color:var(--accent);">FORMATION</h1>
            <p style="color:#888; font-size:0.9rem;">4ëª© ì „ëµ ê²Œì„</p>
            <input type="text" id="nickInput" style="width:100%; padding:15px; margin-bottom:10px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ë‹‰ë„¤ì„">
            <input type="email" id="email" style="width:100%; padding:15px; margin-bottom:10px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" style="width:100%; padding:15px; margin-bottom:20px; background:#111; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box;" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn" onclick="handleAuth('login')">ë¡œê·¸ì¸</button>
            <button class="btn" onclick="handleAuth('signup')" style="background:#333; color:white;">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="lobbyScreen" class="screen">
        <div class="card">
            <h2 style="color:var(--accent)">LOBBY</h2>
            <p><span id="displayNick" style="font-weight:bold;"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</p>
            <p>ë‚´ ìŠ¹ì : <span id="myScore" style="color:var(--accent); font-weight:bold;">0</span> Point</p>
            <button class="btn" onclick="location.href='index.html'" style="background: #333; color: white; margin-top: 15px;">ğŸ² ë£¨ë¹…ìŠ¤ ë ˆì´ìŠ¤ í•˜ëŸ¬ ê°€ê¸°</button>
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            <p style="color:#888; font-size:0.8rem;">ğŸ¤– AI ëŒ€ì „ (ì—°ìŠµ)</p>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-sub" onclick="startAI(1)">ì´ˆê¸‰</button>
                <button class="btn btn-sub" onclick="startAI(2)">ì¤‘ê¸‰</button>
                <button class="btn btn-sub" onclick="startAI(3)" style="color:var(--red);">ê³ ê¸‰</button>
            </div>
            <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
            <p style="color:#888; font-size:0.8rem;">âš”ï¸ ì‹¤ì‹œê°„ ìœ ì € ëŒ€ì „</p>
            <button class="btn" onclick="findMatch()">ì˜¨ë¼ì¸ ë§¤ì¹­ ì‹œì‘</button>
            <button class="btn btn-sub" onclick="auth.signOut()" style="margin-top:20px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="waitScreen" class="screen">
        <div class="card">
            <h2>MATCHING...</h2>
            <div style="border:4px solid #333; border-top:4px solid var(--accent); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto;"></div>
            <p>ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-sub" onclick="cancelMatch()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="gameScreen" class="screen">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="p1Name" style="color:var(--red); font-weight:bold;">RED (ë‚˜)</span>
                <span id="turnInfo" style="background:#fff; color:#000; padding:2px 10px; border-radius:10px; font-size:0.8rem;">-</span>
                <span id="p2Name" style="color:var(--blue); font-weight:bold;">BLUE (AI)</span>
            </div>
            <div id="board" class="board"></div>
            <p id="gameMsg" style="color:var(--accent); font-size:0.9rem; height:20px; margin-top:10px;"></p>
            <button id="quitBtn" class="btn btn-sub" onclick="quitGame()">ë‚˜ê°€ê¸°</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBZZuQHXYsbbJA3L1L8-yFSfbw1w15p3NE",
            authDomain: "rubigs.firebaseapp.com",
            databaseURL: "https://rubigs-default-rtdb.firebaseio.com",
            projectId: "rubigs",
            appId: "1:175818594996:web:2ec5f57abe5f5a20d3d5e1",
            measurementId: "G-DMYD96BWBN"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();

        let myUid = "", myNick = "", myScore = 0;
        let isOnline = false, battleId = null, playerColor = 1; 
        let turn = 1, board = [], lastMove = null;
        let aiLevel = 0, isGameOver = false;

        auth.onAuthStateChanged(user => {
            if(user) {
                myUid = user.uid;
                db.ref(`users/${myUid}`).on('value', snap => {
                    const val = snap.val();
                    myNick = val ? val.nickname : "Player";
                    myScore = val && val.formation_score ? val.formation_score : 0;
                    document.getElementById('displayNick').innerText = myNick;
                    document.getElementById('myScore').innerText = myScore;
                    showScreen('lobbyScreen');
                });
            } else { showScreen('authScreen'); }
        });

        function handleAuth(mode) {
            const e = document.getElementById('email').value, p = document.getElementById('password').value, n = document.getElementById('nickInput').value;
            if(mode==='signup') { auth.createUserWithEmailAndPassword(e,p).then(res=>db.ref(`users/${res.user.uid}`).set({nickname:n, formation_score:0})); }
            else { auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message)); }
        }

        // [ìˆ˜ì •ëœ ë§¤ì¹­ ë¡œì§: ì§ê±°ë˜ ë°©ì‹]
        function findMatch() {
            showScreen('waitScreen');
            const queueRef = db.ref('formation_queue');
            
            queueRef.transaction(current => {
                if (current === null) {
                    return { uid: myUid, name: myNick, matchId: null }; // ë‚´ê°€ ëŒ€ê¸°ì(P1)ê°€ ë¨
                } else {
                    return current; // ì´ë¯¸ ëˆ„ê°€ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
                }
            }, (error, committed, snapshot) => {
                if (error) { alert("ë§¤ì¹­ ì—ëŸ¬"); cancelMatch(); return; }
                
                const data = snapshot.val();
                
                if (committed && data.uid === myUid) {
                    // [ìƒí™© 1] ë‚´ê°€ ëŒ€ê¸°ìê°€ ë¨ -> ëˆ„êµ°ê°€ ë‚´ ëŒ€ê¸°í‘œì— matchId ì ì–´ì¤„ ë•Œê¹Œì§€ ê°ì‹œ
                    queueRef.on('value', snap => {
                        const val = snap.val();
                        if (val && val.matchId) {
                            // ë§¤ì¹­ ì„±ì‚¬! P1(Red)ìœ¼ë¡œ ì‹œì‘
                            queueRef.off(); // ê°ì‹œ ë
                            queueRef.set(null); // ëŒ€ê¸°ì—´ ë¹„ì›Œì£¼ê¸°
                            startOnlineGame(val.matchId, 1, "ìƒëŒ€ë°©");
                        }
                    });
                } else {
                    // [ìƒí™© 2] ì´ë¯¸ ëˆ„ê°€ ìˆìŒ -> ë‚´ê°€ ì°¸ê°€ì(P2)ê°€ ë¨
                    // transactionì´ ì‹¤íŒ¨(committed: false)í–ˆê±°ë‚˜, ì´ë¯¸ ë°ì´í„°ê°€ ìˆì—ˆìŒ
                    if (data && data.uid !== myUid) {
                        const p1Uid = data.uid;
                        const p1Name = data.name;
                        
                        // ë°© ë§Œë“¤ê¸°
                        const newRef = db.ref('formation_battles').push();
                        battleId = newRef.key;
                        
                        // ë°© ë°ì´í„° ì´ˆê¸°í™”
                        newRef.set({
                            p1: p1Uid, p1Name: p1Name,
                            p2: myUid, p2Name: myNick,
                            board: Array(7).fill().map(()=>Array(7).fill(0)),
                            turn: 1, lastMove: null, winner: null
                        }).then(() => {
                            // ëŒ€ê¸°ì—´ì— "ë°© ë²ˆí˜¸(matchId)" ì ì–´ì£¼ê¸° (ì´ëŸ¬ë©´ P1ì´ ë³´ê³  ë“¤ì–´ì˜´)
                            queueRef.update({ matchId: battleId }).then(() => {
                                startOnlineGame(battleId, 2, p1Name);
                            });
                        });
                    } else {
                        // ì¬ì‹œë„
                        setTimeout(findMatch, 500);
                    }
                }
            });
        }

        function cancelMatch() {
            const queueRef = db.ref('formation_queue');
            queueRef.off(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
            queueRef.transaction(current => {
                // ë‚´ê°€ ëŒ€ê¸° ì¤‘ì¼ ë•Œë§Œ ì‚­ì œ
                if (current && current.uid === myUid) return null;
                return current;
            });
            showScreen('lobbyScreen');
        }

        // [ê²Œì„ ì‹¤í–‰ ë¡œì§]
        function startOnlineGame(bid, pColor, oppName) {
            battleId = bid;
            playerColor = pColor;
            
            showScreen('gameScreen');
            // ì´ë¦„ ì„¸íŒ…
            document.getElementById('p1Name').innerText = pColor===1 ? `RED (${myNick})` : `RED (${oppName})`;
            document.getElementById('p2Name').innerText = pColor===2 ? `BLUE (${myNick})` : `BLUE (${oppName})`;
            document.getElementById('p1Name').style.textDecoration = "none";
            document.getElementById('p2Name').style.textDecoration = "none";
            
            // ì´ˆê¸°í™”
            initGame(true, 0, 1);

            // ì‹¤ì‹œê°„ ë™ê¸°í™” (í„´ ë²„ê·¸ ìˆ˜ì •ë¨)
            db.ref(`formation_battles/${battleId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                
                board = data.board;
                lastMove = data.lastMove;
                turn = data.turn;
                
                if(data.winner) endGame(data.winner);
                else {
                    renderBoard();
                    updateUI();
                }
            });
        }

        function initGame(online, level, startTurn) {
            isOnline = online; aiLevel = level; turn = startTurn; isGameOver = false; lastMove = null;
            board = Array(7).fill().map(() => Array(7).fill(0));
            renderBoard();
            updateUI();
            
            if(!online && turn === 2) setTimeout(aiTurn, 500);
        }

        function renderBoard() {
            const b = document.getElementById('board'); b.innerHTML = '';
            const validMoves = getValidMoves();
            
            for(let r=0; r<7; r++) {
                for(let c=0; c<7; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if(board[r][c] !== 0) {
                        const stone = document.createElement('div');
                        stone.className = `stone ${board[r][c] === 1 ? 'red' : 'blue'}`;
                        cell.appendChild(stone);
                        if(lastMove && lastMove.r === r && lastMove.c === c) stone.classList.add('last-move');
                    } else if(!isGameOver && isMyTurnLogic()) {
                        if(validMoves.some(m => m.r === r && m.c === c)) {
                            cell.classList.add('valid-move');
                            cell.onclick = () => makeMove(r, c);
                        }
                    }
                    b.appendChild(cell);
                }
            }
        }
        
        function isMyTurnLogic() {
            if(isOnline) return turn === playerColor;
            return turn === 1; // AIì „ì€ í•­ìƒ ë‚´ê°€ 1(RED)
        }

        function getValidMoves() {
            let moves = [];
            if(lastMove === null) { // ì²« ìˆ˜ëŠ” ì•„ë¬´ë°ë‚˜
                for(let r=0; r<7; r++) for(let c=0; c<7; c++) if(board[r][c]===0) moves.push({r,c});
                return moves;
            }
            for(let dr=-1; dr<=1; dr++) {
                for(let dc=-1; dc<=1; dc++) {
                    if(dr===0 && dc===0) continue;
                    let nr = lastMove.r + dr, nc = lastMove.c + dc;
                    if(nr>=0 && nr<7 && nc>=0 && nc<7 && board[nr][nc]===0) moves.push({r:nr, c:nc});
                }
            }
            if(moves.length === 0) { // ë‘˜ ê³³ ì—†ìœ¼ë©´ í”„ë¦¬ ë£°
                for(let r=0; r<7; r++) for(let c=0; c<7; c++) if(board[r][c]===0) moves.push({r,c});
            }
            return moves;
        }

        function makeMove(r, c) {
            if(isGameOver) return;
            board[r][c] = turn;
            lastMove = {r, c};
            
            if(checkWin(r, c, turn)) {
                if(isOnline) db.ref(`formation_battles/${battleId}`).update({board, lastMove, turn, winner: turn});
                else endGame(turn);
                return;
            }

            turn = turn === 1 ? 2 : 1;
            
            if(isOnline) {
                db.ref(`formation_battles/${battleId}`).update({board, lastMove, turn});
            } else {
                renderBoard(); updateUI();
                if(turn === 2) setTimeout(aiTurn, 600);
            }
        }

        function aiTurn() {
            if(isGameOver) return;
            const validMoves = getValidMoves();
            if(validMoves.length === 0) return; 

            let pick = validMoves[0];
            if(aiLevel > 1) { // ì¤‘ê¸‰ ì´ìƒ
                // 1. í‚¬ê°
                let winMove = validMoves.find(m => { board[m.r][m.c]=2; let w=checkWin(m.r,m.c,2); board[m.r][m.c]=0; return w; });
                if(winMove) pick = winMove;
                else {
                    // 2. ë°©ì–´
                    let blockMove = validMoves.find(m => { board[m.r][m.c]=1; let w=checkWin(m.r,m.c,1); board[m.r][m.c]=0; return w; });
                    if(blockMove) pick = blockMove;
                    else if(aiLevel === 3) pick = validMoves[Math.floor(Math.random()*validMoves.length)]; // ê³ ê¸‰ì€ ëœë¤ ì„ìŒ
                    else pick = validMoves[Math.floor(Math.random()*validMoves.length)];
                }
            } else {
                pick = validMoves[Math.floor(Math.random()*validMoves.length)];
            }
            makeMove(pick.r, pick.c);
        }

        function checkWin(r, c, p) {
            const directions = [[0,1], [1,0], [1,1], [1,-1]];
            for(let d of directions) {
                let count = 1;
                for(let k=1; k<4; k++) { let nr=r+d[0]*k, nc=c+d[1]*k; if(nr<0||nr>6||nc<0||nc>6||board[nr][nc]!==p) break; count++; }
                for(let k=1; k<4; k++) { let nr=r-d[0]*k, nc=c-d[1]*k; if(nr<0||nr>6||nc<0||nc>6||board[nr][nc]!==p) break; count++; }
                if(count >= 4) return true;
            }
            return false;
        }

        function updateUI() {
            const info = document.getElementById('turnInfo');
            if(isGameOver) return;
            
            // í„´ í‘œì‹œ ë¡œì§ ê°œì„ 
            if (turn === 1) { // RED Turn
                info.innerText = (playerColor === 1) ? "ë‚´ ì°¨ë¡€ (RED)" : "ìƒëŒ€ ì°¨ë¡€ (RED)";
                info.style.background = "var(--red)";
                info.style.color = "white";
                document.getElementById('p1Name').style.textDecoration = "underline";
                document.getElementById('p2Name').style.textDecoration = "none";
            } else { // BLUE Turn
                info.innerText = (playerColor === 2) ? "ë‚´ ì°¨ë¡€ (BLUE)" : "ìƒëŒ€ ì°¨ë¡€ (BLUE)";
                info.style.background = "var(--blue)";
                info.style.color = "white";
                document.getElementById('p1Name').style.textDecoration = "none";
                document.getElementById('p2Name').style.textDecoration = "underline";
            }
        }

        function endGame(winner) {
            isGameOver = true;
            let msg = "";
            document.getElementById('turnInfo').innerText = "ê²Œì„ ì¢…ë£Œ";
            document.getElementById('turnInfo').style.background = "#333";
            
            if(isOnline) {
                if(winner === playerColor) { msg = "ğŸ‰ ìŠ¹ë¦¬! (+10ì )"; updateScore(10); }
                else { msg = "íŒ¨ë°°... (-5ì )"; updateScore(-5); }
                if(battleId) db.ref(`formation_battles/${battleId}`).off(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
            } else {
                msg = winner === 1 ? "ğŸ‰ ìŠ¹ë¦¬!" : "íŒ¨ë°°...";
            }
            document.getElementById('gameMsg').innerText = msg;
            renderBoard();
        }

        function updateScore(v) { db.ref(`users/${myUid}/formation_score`).transaction(c => (c||0) + v); }
        function startAI(lv) { 
            document.getElementById('p1Name').innerText = "RED (ë‚˜)"; 
            document.getElementById('p2Name').innerText = "BLUE (AI)";
            showScreen('gameScreen'); initGame(false, lv, 1); 
        }
        function quitGame() {
            if(isOnline && !isGameOver) updateScore(-5);
            if(battleId) { db.ref(`formation_battles/${battleId}`).off(); }
            cancelMatch(); // íì—ì„œ ì œê±°
            showScreen('lobbyScreen');
        }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        
        // ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì¶”ê°€
        const style = document.createElement('style');
        style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
